<?php
/**
 * @ author : Sabbana
 * @ corp : Pajon/sstud-io.net
 * @ date : 21-09-2016
 */

class Mdl_cms extends CI_Model{

	public function __construct(){
		parent::__construct();
	}

	# log_activities
	public function log($user, $event, $table, $item){
		$data = array(
			'user_id' => $user,
			'event'	=> $event,
			'table_relation'	=> $table,
			'item_id'	=> $item,
			'ip_address'	=> $_SERVER['REMOTE_ADDR'],
			'device'	=> $_SERVER['HTTP_USER_AGENT']
		);
		return $this->db->insert('log_activities', $data);
	}

	public function log_submission($sub_id, $status, $desc){
		$data = array(
			'sub_id'	=> $sub_id,
			'sub_status'	=> $status,
			'log_desc'	=> $desc
		);
		return $this->db->insert('submission_log_status', $data);
	}

	# get country
	public function get_countries(){
		$sql = "select * from countries order by country_name ASC";
		return $this->db->query($sql)->result_array();
	}
	
	# general crud
	public function insert($table, $data){
		return $this->db->insert($table, $data);
	}
	
	public function update($table, $param=array(), $data){
		if(empty($param))
			return $this->db->update($table, $data);
		else{
			$this->db->where($param[0], $param[1]);
			return $this->db->update($table, $data);			
		}
	}

	public function update_review($sub_id, $email_reviewer, $data){
		$this->db->where('sub_id', $sub_id);
		$this->db->where('reviewer_email', $email_reviewer);
		return $this->db->update('submission_review', $data);
	}

	public function get_review_item($sub_id, $round, $email){
		$sql = "select * from submission_review where sub_id = '$sub_id' and round = '$round' and reviewer_email = '$email'";
		return $this->db->query($sql)->result_array();
	}

	public function check_count_review($sub_id, $round = 1){
		$sql = "select * from submission_review where sub_id = '$sub_id' and review_result is NOT NULL and round = '$round'";
		return $this->db->query($sql)->num_rows();
	}
	
	public function check_existing_review_form($sub_id, $round, $email){
		$sql = "select * from submission_review where sub_id = '$sub_id' and round = '$round' and reviewer_email = '$email'";
		return $this->db->query($sql)->num_rows();
	}

	public function check_review_active($sub_id){
		$sql = "select sub_status from submission where sub_id = '$sub_id'";
		$result = $this->db->query($sql)->result_array();
		$res = false;
		if(!empty($result)){
			if(in_array($result[0]['sub_status'], array(3,4,5)))
				$res = true;
		}
		return $res;
	}

	public function delete($table, $param=array()){
		$this->db->where($param[0], $param[1]);
		return $this->db->delete($table);
	}
	
	# static pages
	public function get_all_page(){
		$sql = "select * from page order by page_title ASC";
		return $this->db->query($sql)->result_array();
	}
	public function current_page($id){
		$sql = "select * from page where page_id = '$id'";
		return $this->db->query($sql)->result_array();
	}


	# announcement
	public function get_all_announcement(){
		$sql = "select * from announcement order by date_input DESC";
		return $this->db->query($sql)->result_array();
	}
	public function current_announcement($id){
		$sql = "select * from announcement where ann_id = '$id'";
		return $this->db->query($sql)->result_array();	
	}

	# journal section
	public function get_all_section(){
		$sql = "select * from section order by sort ASC";
		return $this->db->query($sql)->result_array();
	}
	public function current_section($id){
		$sql = "select * from section where section_id = '$id'";
		return $this->db->query($sql)->result_array();
	}
	public function get_section_editor($sec_id){
		$sql = "select a.*, b.salutation, b.first_name, b.last_name, b.email, b.phone, b.fax, b.affiliation from section_editor a
				right join users b on a.user_id = b.user_id
				where a.section_id = '$sec_id'";
		return $this->db->query($sql)->result_array();
	}
	public function get_available_editor($sec_id = ''){
		$sql = "select a.*,  b. first_name, b.last_name, b.affiliation from roleuser a left join users b on a.user_id = b.user_id
				where a.role_id = '4' and a.user_id not in (select user_id from section_editor where section_id = '$sec_id')";
		return $this->db->query($sql)->result_array();
	}

	# issue 
	public function get_all_issue(){
		$sql = "select * from issue ORDER BY issue_id DESC";
		return $this->db->query($sql)->result_array();
	}
	
	public function current_issue($id){
		$sql = "select * from issue where issue_id = '$id'";
		return $this->db->query($sql)->result_array();
	}

	public function update_issue_status($id){
		$this->db->query('update issue set status = 0');
		$sql = "update issue set status = 1 where issue_id = '$id'";
		return $this->db->query($sql);
	}

	# user models
	# ======================================================
	# this function will be expired by uploading new version
	public function get_author_from_user($uid, $sub_id){
		$sql = "select * from submission_author where email = (select email from users where user_id = '$uid') and sub_id = '$sub_id'";
		return $this->db->query($sql)->result_array();
	}

	public function get_author_not_user($uid, $sub_id, $for_email = false){
		$sql = "select * from submission_author where email not in (select email from users where user_id = '$uid') and sub_id = '$sub_id'";
		if ($for_email)
			return $this->db->query($sql)->result_array();	
		else{
			$emails = arary();
			$data = $this->db->query($sql)->result_array();
			if(!empty($data)){
				foreach ($data as $e) {
					array_push($emails, $e['email']);
				}
			}
			return $emails;
		}
	}
	# this function will be expired by uploding new version

	public function get_corresponding_author($sub_id, $for_email = false){
		$sql = "select * from submission_author where sub_id = '$sub_id' and corresponding = 1";
		$data = $this->db->query($sql)->result_array();
		if(empty($data)){
			$sql = "select * from submission_author where sub_id = '$sub_id'";
			$res = $this->db->query($sql)->result_array();
			if(count($res) > 1)
				$data[0] = $res[0];
			else $data = $res;
		}
		if($for_email){
			$res = array();
			array_push($res, $data[0]['email']);
			return $res;
		}else return $data;
	}
	
	public function get_other_author($sub_id, $for_email = false){
		$sql = "select * from submission_author where sub_id = '$sub_id' and corresponding = 0";
		$data = $this->db->query($sql)->result_array();
		$check_ca = $this->get_corresponding_author($sub_id);
		// return $check_ca;
		if($for_email){
			$res = array();
			if(!empty($data)){
				foreach ($data as $e) {
					if(!empty($check_ca)){
						if($check_ca[0]['first_name'] !== $e['first_name'])
							array_push($res, $e['email']);
					}else{
						array_push($res, $e['email']);
					}
				}
			}
			return $res;
		}else{
			$res = array();
			if(!empty($check_ca)){
				foreach ($data as $author) {
					if($check_ca[0]['first_name'] !== $author['first_name'])
						array_push($res, $author);
				}
			}
			return $res;
		}
	}

	public function count_user($role = null){
		$sql = "select * from users";
		if($role !== null)
			$sql = "select * from roleuser where role_id = '$role'";
		return $this->db->query($sql)->num_rows();
	}

	public function get_user($uid=""){
		$id = $this->session->userdata('user_id');
		if($uid != "")
			$id = $uid;

		$sql = "select a.*, b.section_id, b.section_title from users a left join section b on a.section_id = b.section_id where a.user_id = '$id'";
		if(strlen($id) == 32)
			$sql = "select a.*, b.section_id, b.section_title from users a left join section b on a.section_id = b.section_id where md5(a.user_id) = '$id'";
		return $this->db->query($sql)->result_array();
	}
	
	public function get_all_users(){
		$sql = "select * from users
				order by date_create DESC";
		return $this->db->query($sql)->result_array();
	}

	public function get_all_user_paging($num = 25, $offset = 0){
		$this->db->select('*');		
		$this->db->order_by("date_create", "DESC"); 
		return $this->db->get('users', $num, $offset)->result_array();
	}

	public function count_all_user(){
		$this->db->select('*');
		return $this->db->get('users')->num_rows();
	}
	
	public function count_search_user($filter, $keyword){
		$this->db->select('*');
		$this->db->like($filter, $keyword);
		return $this->db->get('users')->num_rows();
	}
	
	public function get_search_user($filter, $keyword, $num = 25, $offset = 0){		
		$this->db->select('*');
		$this->db->like($filter, $keyword);
		$res = $this->db->get('users', $num, $offset)->result_array();
		return $res;
	}

	public function get_role_user($uid){
		$sql = "select * from roleuser a left join role b on a.role_id = b.role_id where a.user_id = '$uid'";
		return $this->db->query($sql)->result_array();
	}

	public function get_all_user_active(){
		$sql = "select a.*, b.role_name from users a 
				left join role b on a.role_id = b.role_id				
				where a.role_id != 1 and a.status = 1 order by date_create DESC";
		return $this->db->query($sql)->result_array();		
	}

	public function check_user_email($email){
		$sql = "select * from users where email = '$email'";
		return $this->db->query($sql)->num_rows();
	}
	
	public function get_user_from_mail($email){
		$sql = "select * from users where email = '$email'";
		return $this->db->query($sql)->result_array();
	}

	public function default_author($sub_id, $id){
		$data = $this->db->query("select * from users where user_id = '$id'")->result_array();
		$sql = "insert into submission_author (sub_id, salutation, first_name, last_name, email, affiliation, short_biography, country, corresponding) 
				values ('".$sub_id."','".$data[0]['salutation']."','".$this->db->escape_str($data[0]['first_name'])."','".$this->db->escape_str($data[0]['last_name'])."','".$data[0]['email']."','- ".$this->db->escape_str($data[0]['affiliation']).'<br/>- '.$this->db->escape_str($data[0]['affiliation2'])."','".$this->db->escape_str($data[0]['short_biography'])."','".$this->db->escape_str($data[0]['country'])."','1')";
		return $this->db->query($sql);
	}

	public function set_coauthor($sub_id, $sa_id){
		$this->db->query("update submission_author set corresponding = 0 where sub_id = '$sub_id'");
		return $this->db->query("update submission_author set corresponding = 1 where sa_id = '$sa_id'");
	}
	# submission
	public function check_submission_active($sub_id){
		$sql = "select sub_status from submission where sub_id = '$sub_id'";
		$result = $this->db->query($sql)->result_array();
		$res = false;
		if(!empty($result)){
			if($result[0]['sub_status'] < 8)
				$res = true;
		}
		return $res;
	}
	
	public function check_submission_active_revise($sub_id){
		$sql = "select sub_status from submission where sub_id = '$sub_id'";
		$result = $this->db->query($sql)->result_array();
		$res = false;
		if(!empty($result)){
			if(in_array($result[0]['sub_status'], array(0, 7))){
				$res = true;
			}
		}
		return $res;
	}

	public function is_send_back($sub_id){
		$sql = "select * from submission_review where sub_id = '$sub_id'";
		$count = $this->db->query($sql)->num_rows();
		$res = 'Send back to author';
		if($count > 0)
			$res = 'Revise';
		return $res;
	}

	public function count_submission_status($status = null){
		$sql = "select sub_id from submission where sub_status > 0";
		if($status !== null)
			$sql = "select sub_id from submission where sub_status = '$status'";
			if($status == "completed")
				$sql = "select sub_id from submission where sub_status in (8, 9, 10, 99)";
		return $this->db->query($sql)->num_rows();
	}
	
	public function count_submission_status_by_section($section, $status = null){
		if(!empty($section)){
			$sql = "select sub_id from submission where section_id in (".implode(',', $section).") and sub_status > 0";
			if($status !== null)
				$sql = "select sub_id from submission where section_id in (".implode(',', $section).") and sub_status = '$status'";
				if($status == "completed")
					$sql = "select sub_id from submission where section_id in (".implode(',', $section).") and sub_status in (8, 9, 10, 99)";
			return $this->db->query($sql)->num_rows();
		}else return 0;
	}

	public function count_submission_status_by_user($user_id, $status = null){
		$sql = "select sub_id from submission";
		if($status !== null)
			$sql = "select sub_id from submission where sub_status = '$status' and user_id = '$user_id'";
		return $this->db->query($sql)->num_rows();
	}

	public function get_submission_status_by_user($user_id, $status = null){
		$sql = "select * from submission where sub_status = '$status' and user_id = '$user_id'";
		if ($status == 3)
			$sql = "select * from submission where sub_status in (3,4,5,6) and user_id = '$user_id'";
		return $this->db->query($sql)->result_array();
	}

	public function get_submission_section($array_section, $status = null){
		if(empty($array_section))
			return array();

		$sql = "select a.sub_id, a.sub_title, a.round, a.user_id, a.section_id, a.sub_status, a.date_submit, b.section_title, b.section_abv from submission a 
				left join section b on a.section_id = b.section_id where a.section_id in (".implode(',', $array_section).") and a.sub_status != 0
				order by a.date_input DESC";
		if ($status !== null){			
			$sql = "select a.sub_id, a.sub_title, a.round, a.user_id, a.section_id, a.sub_status, a.date_submit, b.section_title, b.section_abv from submission a 
				left join section b on a.section_id = b.section_id where a.section_id in (".implode(',', $array_section).") and a.sub_status = '$status'
				order by a.date_input DESC";
			if($status == 'completed'){
				$sql = "select a.sub_id, a.sub_title, a.round, a.user_id, a.section_id, a.sub_status, a.date_submit, b.section_title, b.section_abv from submission a 
					left join section b on a.section_id = b.section_id where a.section_id in (".implode(',', $array_section).") and a.sub_status in (8,9,10)
					order by a.date_input DESC";
			}
		}
		return $this->db->query($sql)->result_array();		
	}

	public function get_all_submission($user_id = '', $status = ''){
		$sql = "select a.sub_id, a.round, a.sub_title, a.user_id, a.section_id, a.sub_status, a.date_submit, b.section_title, b.section_abv, a.read_ethics, a.not_publish from
			 	submission a left join section b on a.section_id = b.section_id where a.sub_status != 0 order by a.date_input DESC";
		if ($user_id !== ''){
			$filter = "a.sub_status in (8, 9, 10, 11, 12, 99)";
			if($status == 'active')
				$filter = "a.sub_status < 8";
			
			$sql = "select a.sub_id, a.round, a.sub_title, a.user_id, a.section_id, a.sub_status, a.date_submit, b.section_title, b.section_abv, a.read_ethics, a.not_publish from 
					submission a left join section b on a.section_id = b.section_id where a.user_id = '$user_id' and ".$filter." 
					order by a.date_input DESC";
			
		}
		return $this->db->query($sql)->result_array();
	}

	public function get_submission_status($sts){
		$sql = "select a.sub_id, a.sub_title, a.round, a.user_id, a.section_id, a.sub_status, a.date_submit, b.section_title, b.section_abv, a.read_ethics, a.not_publish 
				from submission a 
				left join section b on a.section_id = b.section_id where a.sub_status = '$sts'
				order by a.date_input DESC";
		if($sts == 'completed'){
			$sql = "select a.sub_id, a.sub_title, a.round, a.user_id, a.section_id, a.sub_status, a.date_submit, b.section_title, b.section_abv, a.read_ethics, a.not_publish 
				 from submission a 
				left join section b on a.section_id = b.section_id where a.sub_status in (8, 9, 10, 99)
				order by a.date_input DESC";
		}
		return $this->db->query($sql)->result_array();
	}

	# submission paging query and search
	# =====================================================
	
	/**
	 * submission list by status paging and search keyword
	 */
	public function get_submission_status_paging($sts, $num=10, $offset=0, $key=null){
		$this->db->select('distinct(a.sub_id) as sub_id, a.sub_title, a.round, a.user_id, a.section_id, a.sub_status, a.date_submit, b.section_title, b.section_abv, a.read_ethics, a.not_publish');
		$this->db->join('section b', 'a.section_id = b.section_id', 'left');
		$this->db->join('submission_author c', 'a.sub_id = c.sub_id', 'left');
		
		if($key != null){
			if (strpos($key, 'id:') !== FALSE){
				$param = explode(':', $key);
				$this->db->where('a.sub_id', $param[1]);
			}else{
				$this->db->group_start();
					$this->db->or_group_start();
						$this->db->like('a.sub_title', $key);
						$this->db->or_like('c.first_name', $key);
						$this->db->or_like('c.last_name', $key);
					$this->db->group_end();
				$this->db->group_end();
			}
		}

		if ($sts == 'completed')
			$this->db->where_in('a.sub_status', array(8,9,10,99));
		else $this->db->where('a.sub_status', $sts);

		$this->db->group_by('a.sub_id');
		$this->db->order_by("a.date_submit", "DESC"); 
		return $this->db->get('submission a', $num, $offset)->result_array();		
	}
	
	/**
	 * submission total records by status paging and search keyword 
	 */
	public function count_submission_status_by_keyword($key, $sts){
		$this->db->select('distinct(a.sub_id) as sub_id, a.sub_title, a.round, a.user_id, a.section_id, a.sub_status, a.date_submit, b.section_title, b.section_abv, a.read_ethics, a.not_publish');
		$this->db->join('section b', 'a.section_id = b.section_id', 'left');
		$this->db->join('submission_author c', 'a.sub_id = c.sub_id', 'left');

		if($key != null){
			if (strpos($key, 'id:') !== FALSE){
				$param = explode(':', $key);
				$this->db->where('a.sub_id', $param[1]);
			}else{
				$this->db->group_start();
					$this->db->or_group_start();
						$this->db->like('a.sub_title', $key);
						$this->db->or_like('c.first_name', $key);
						$this->db->or_like('c.last_name', $key);
					$this->db->group_end();
				$this->db->group_end();
			}
		}
		
		if ($sts == 'completed')
			$this->db->where_in('a.sub_status', array(8,9,10,99));
		else $this->db->where('a.sub_status', $sts);

		$this->db->group_by('a.sub_id');
		return $this->db->get('submission a')->num_rows();		
	}

	/**
	 * submission list by user paging and search keyword
	 */	
	public function get_all_submission_secretariat_paging($num=10, $offset=0, $key=null){
		$this->db->select('distinct(a.sub_id) as sub_id, a.sub_title, a.round, a.user_id, a.section_id, a.sub_status, a.date_submit, b.section_title, b.section_abv, a.read_ethics, a.not_publish');
		$this->db->join('section b', 'a.section_id = b.section_id', 'left');
		$this->db->join('submission_author c', 'a.sub_id = c.sub_id', 'left');
		
		if($key != null){
			if (strpos($key, 'id:') !== FALSE){
				$param = explode(':', $key);
				$this->db->where('a.sub_id', $param[1]);
			}else{
				$this->db->group_start();
					$this->db->or_group_start();
						$this->db->like('a.sub_title', $key);
						$this->db->or_like('c.first_name', $key);
						$this->db->or_like('c.last_name', $key);
					$this->db->group_end();
				$this->db->group_end();
			}
		}
		$this->db->where('a.sub_status > ', 0);

		$this->db->group_by('a.sub_id');
		$this->db->order_by("a.date_submit", "DESC"); 
		return $this->db->get('submission a', $num, $offset)->result_array();
	}

	/**
	 * submission list by user paging and search keyword
	 */	
	public function count_all_submission_secretariat_keyword($key=null){
		$this->db->select('distinct(a.sub_id) as sub_id, a.sub_title, a.round, a.user_id, a.section_id, a.sub_status, a.date_submit, b.section_title, b.section_abv, a.read_ethics, a.not_publish');
		$this->db->join('section b', 'a.section_id = b.section_id', 'left');
		$this->db->join('submission_author c', 'a.sub_id = c.sub_id', 'left');
		
		if($key != null){
			if (strpos($key, 'id:') !== FALSE){
				$param = explode(':', $key);
				$this->db->where('a.sub_id', $param[1]);
			}else{
				$this->db->group_start();
					$this->db->or_group_start();
						$this->db->like('a.sub_title', $key);
						$this->db->or_like('c.first_name', $key);
						$this->db->or_like('c.last_name', $key);
					$this->db->group_end();
				$this->db->group_end();
			}
		}
		$this->db->where('a.sub_status > ', 0);		
		$this->db->group_by('a.sub_id');
		return $this->db->get('submission a')->num_rows();
	}


	/**
	 * submission list by user paging and search keyword
	 */	
	public function get_all_submission_author_paging($user_id, $status, $num=10, $offset=0, $key=null){
		$this->db->select('distinct(a.sub_id) as sub_id, a.sub_title, a.round, a.user_id, a.section_id, a.sub_status, a.date_submit, b.section_title, b.section_abv, a.read_ethics, a.not_publish');
		$this->db->join('section b', 'a.section_id = b.section_id', 'left');
		$this->db->join('submission_author c', 'a.sub_id = c.sub_id', 'left');
		
		if($key != null){
			if (strpos($key, 'id:') !== FALSE){
				$param = explode(':', $key);
				$this->db->where('a.sub_id', $param[1]);
			}else{
				$this->db->group_start();
					$this->db->or_group_start();
						$this->db->like('a.sub_title', $key);
						$this->db->or_like('c.first_name', $key);
						$this->db->or_like('c.last_name', $key);
					$this->db->group_end();
				$this->db->group_end();
			}
		}
		if($status == 'active'){
			$this->db->where('a.sub_status < ', 8);
		}

		if($status == 'archive'){
			$this->db->where('a.sub_status > ', 8);
		}

		$this->db->where('a.user_id', $user_id);

		$this->db->group_by('a.sub_id');
		$this->db->order_by("a.date_submit", "DESC"); 
		return $this->db->get('submission a', $num, $offset)->result_array();
	}

	/**
	 * submission list by author paging and search keyword
	 */	
	public function count_all_submission_author_keyword($user_id, $status, $key=null){
		$this->db->select('distinct(a.sub_id) as sub_id, a.sub_title, a.round, a.user_id, a.section_id, a.sub_status, a.date_submit, b.section_title, b.section_abv, a.read_ethics, a.not_publish');
		$this->db->join('section b', 'a.section_id = b.section_id', 'left');
		$this->db->join('submission_author c', 'a.sub_id = c.sub_id', 'left');
		
		if($key != null){
			if (strpos($key, 'id:') !== FALSE){
				$param = explode(':', $key);
				$this->db->where('a.sub_id', $param[1]);
			}else{
				$this->db->group_start();
					$this->db->or_group_start();
						$this->db->like('a.sub_title', $key);
						$this->db->or_like('c.first_name', $key);
						$this->db->or_like('c.last_name', $key);
					$this->db->group_end();
				$this->db->group_end();
			}
		}
		if($status == 'active'){
			$this->db->where('a.sub_status < ', 8);
		}

		if($status == 'archive'){
			$this->db->where('a.sub_status > ', 8);
		}
		$this->db->where('a.user_id', $user_id);		
		$this->db->group_by('a.sub_id');
		return $this->db->get('submission a')->num_rows();
	}


	/**
	 * submission list by section editor paging and search keyword
	 */	
	public function get_all_submission_editor_section_keyword($array_section, $status, $num=10, $offset=0, $key=null){
		$this->db->select('distinct(a.sub_id) as sub_id, a.sub_title, a.round, a.user_id, a.section_id, a.sub_status, a.date_submit, b.section_title, b.section_abv, a.read_ethics, a.not_publish');
		$this->db->join('section b', 'a.section_id = b.section_id', 'left');
		$this->db->join('submission_author c', 'a.sub_id = c.sub_id', 'left');
		
		if($key != null){
			if (strpos($key, 'id:') !== FALSE){
				$param = explode(':', $key);
				$this->db->where('a.sub_id', $param[1]);
			}else{
				$this->db->group_start();
					$this->db->or_group_start();
						$this->db->like('a.sub_title', $key);
						$this->db->or_like('c.first_name', $key);
						$this->db->or_like('c.last_name', $key);
					$this->db->group_end();
				$this->db->group_end();
			}
		}
		if(!empty($array_section)){
			$this->db->where_in('a.section_id', $array_section);
		}
		if($status == 'completed'){			
			$this->db->where_in('a.sub_status', array(8,9,10,99));
		}else $this->db->where('a.sub_status', $status);

		$this->db->where('a.sub_status > ', 0);
		$this->db->group_by('a.sub_id');
		$this->db->order_by("a.date_submit", "DESC"); 
		return $this->db->get('submission a', $num, $offset)->result_array();		
	}

	/**
	 * submission list by author paging and search keyword
	 */	
	public function count_all_submission_editor_section_keyword($array_section, $status, $key=null){
		$this->db->select('distinct(a.sub_id) as sub_id, a.sub_title, a.round, a.user_id, a.section_id, a.sub_status, a.date_submit, b.section_title, b.section_abv, a.read_ethics, a.not_publish');
		$this->db->join('section b', 'a.section_id = b.section_id', 'left');
		$this->db->join('submission_author c', 'a.sub_id = c.sub_id', 'left');
		
		if($key != null){
			if (strpos($key, 'id:') !== FALSE){
				$param = explode(':', $key);
				$this->db->where('a.sub_id', $param[1]);
			}else{
				$this->db->group_start();
					$this->db->or_group_start();
						$this->db->like('a.sub_title', $key);
						$this->db->or_like('c.first_name', $key);
						$this->db->or_like('c.last_name', $key);
					$this->db->group_end();
				$this->db->group_end();
			}
		}
		if(!empty($array_section)){
			$this->db->where_in('a.section_id', $array_section);
		}
		if($status == 'completed'){
			$this->db->where_in('a.sub_status', array(8,9,10,99));
		}else $this->db->where('a.sub_status', $status);

		$this->db->where('a.sub_status > ', 0);
		$this->db->group_by('a.sub_id');
		return $this->db->get('submission a')->num_rows();
	}

	
	# ========================================================

	public function get_submission_status_limit($sts, $limit){
		$order = 'a.date_submit';
		if($sts == 8)
			$order = 'x.date_accept';

		$sql = "select a.sub_id, a.sub_title, a.round, a.user_id, a.section_id, a.sub_status, a.date_submit, b.section_title, b.section_abv, a.read_ethics, a.not_publish, x.date_accept from submission a 
				left join journal x on a.sub_id = x.sub_id 
				left join section b on a.section_id = b.section_id 
				where a.sub_status = '$sts'
				order by ".$order." DESC limit 0, $limit";		
		return $this->db->query($sql)->result_array();
	}

	public function current_submission($sid){
		$sql = "select a.*, b.section_id, b.section_abv, b.section_title from submission a 
				left join section b on a.section_id = b.section_id where a.sub_id = '$sid'";
		return $this->db->query($sql)->result_array();		
	}

	public function count_submission_issue($issue_id){
		$sql = "select * from journal where issue_id = '$issue_id'";
		return $this->db->query($sql)->num_rows();
	}

	public function get_journal_issue($issue_id){
		$sql = "select a.*, b.*, c.section_id, c.section_abv, c.section_title, b.round from journal a 
				left join submission b on a.sub_id = b.sub_id 
				left outer join section c on c.section_id = b.section_id
				where a.issue_id = '$issue_id'";
		return $this->db->query($sql)->result_array();
	}

	public function withdraw_manuscript($sub_id, $reason){
		$this->db->query("update submission_reviewer set status = 3 where sub_id = '$sub_id'");		
		$this->db->where('sub_id', $sub_id);
		return $this->db->update('submission', array('sub_status' => 99, 'date_withdraw' => date('Y-m-d H:i:s'), 'withdraw_reason' => $reason));		
	}

	public function get_submit_date_history($sub_id){
		$sql = "select * from submission_log_status where sub_id = '$sub_id' and sub_status = 1 order by date_log ASC";
		return $this->db->query($sql)->result_array();
	}
	# author models
	# ===================================================
	public function get_author_submission($sid){
		$sql = "select * from submission_author where sub_id = '$sid' order by sort ASC";
		return $this->db->query($sql)->result_array();
	}

	public function get_coauthor_submission($sid){
		$sql = "select * from submission_author where sub_id = '$sid' and corresponding = 1  order by sort ASC";
		return $this->db->query($sql)->result_array();
	}

	public function get_email_author_from_sub_id($sub){
		$sql = "select * from submission_author where sub_id = '$sub' order by sa_id ASC";
		$data = $this->db->query($sql)->result_array();
		$res = '';
		if(!empty($data))
			$res = $data[0]['email'];
		return $res;
	}

	public function count_author_submission($sid){
		$sql = "select * from submission_author where sub_id = '$sid'";
		return $this->db->query($sql)->num_rows();
	}

	public function get_role_by_email_address($email, $role){
		$sql = "select * from roleuser a left join users b on a.user_id = b.user_id where b.email = '$email' and role_id = '$role'";
		return $this->db->query($sql)->result_array();
	}
	
	public function get_role_by_keywords($key, $role){
		$sql = "select * from roleuser a left join users b on a.user_id = b.user_id where 
				((b.email like '%$key%' or 
				b.first_name like '%$key%' or 
				b.expertise like '%$key%' or 
				b.last_name like '%$key%') and b.section_id != 0 )
				and (role_id = '$role') order by b.first_name ASC";
		return $this->db->query($sql)->result_array();
	}

	public function get_suggested_reviewer($key){
		$sql = "select distinct(email) as email, fullname, salutation, expertise, affiliation, sr_id from submission_reviewer where 
				email like '%$key%' or 
				fullname like '%$key%' or 
				affiliation like '%$key%' or 
				expertise like '%$key%'
				group by email order by fullname ASC";
		return $this->db->query($sql)->result_array();		
	}

	public function get_author_affiliation($sub_id){
		$sql = "select a.affiliation, a.affiliation2, b.first_name, b.last_name from users a left join submission_author b on a.email = b.email
				where b.email in (select email from submission_author where sub_id = '$sub_id')";
		return $this->db->query($sql)->result_array();		
	}

	# reviewer models
	# ====================================================
	public function get_submission_reviewer_active($sid){
		$sql = "select * from submission_reviewer where sub_id = '$sid' and status = 1 order by date_input ASC";
		return $this->db->query($sql)->result_array();	
	}

	public function get_submission_reviewer($sid){
		$sql = "select * from submission_reviewer where sub_id = '$sid' order by date_input ASC";
		return $this->db->query($sql)->result_array();	
	}

	public function get_reviewer_by_email_address($sub_id, $email){
		$sql = "select * from submission_reviewer where sub_id != '$sub_id' and email = '$email' group by email";
		return $this->db->query($sql)->result_array();
	}

	public function get_user_reviewer($review_id){
		$sql = "select * from users where email = (select reviewer_email from submission_review where review_id = '$review_id')";
		return $this->db->query($sql)->result_array();
	}	

	public function get_submission_file($sid, $round = 1){
		$sql = "select * from submission_file where sub_id = '$sid' and round = '$round' order by date_input ASC";
		return $this->db->query($sql)->result_array();	
	}

	public function get_current_author($sa){
		$sql = "select * from submission_author where sa_id = '$sa'";
		return $this->db->query($sql)->result_array();
	}

	public function get_existing_authors($sid){
		$sql = "select * from submission_author where sub_id != '$sid' group by email";
		return $this->db->query($sql)->result_array();
	}

	public function get_existing_reviewers($sid){
		$sql = "select * from submission_reviewer where sub_id != '$sid' group by email";
		return $this->db->query($sql)->result_array();
	}

	public function get_reviewers($sid, $email = null){
		$sql = "select * from submission_reviewer where sub_id = '$sid' order by date_input ASC";
		if($email !== null)
			$sql = "select * from submission_reviewer where sub_id = '$sid' and email='$email' order by date_input ASC";
		return $this->db->query($sql)->result_array();
	}
	
	public function get_reviewers_from_ids($ids = array()){
		$sql = "select * from submission_reviewer where sr_id in (".implode(',', $ids).") order by date_input ASC";
		return $this->db->query($sql)->result_array();
	}

	public function get_reviewers_active($sid){
		$sql = "select * from submission_reviewer where sub_id = '$sid' and status = 1 order by date_input ASC";
		return $this->db->query($sql)->result_array();
	}

	public function get_current_reviewer($sr_id){
		$sql = "select * from submission_reviewer where sr_id = '$sr_id'";
		return $this->db->query($sql)->result_array();
	}

	public function update_reviewer_status($sub_id, $email, $status){
		$sql = "update submission_reviewer set status = '$status' where sub_id = '$sub_id' and email = '$email'";
		return $this->db->query($sql);
	}

	# model file submission
	public function current_suplement_file($id){
		$sql = "select * from submission_file where sf_id = '$id'";
		return $this->db->query($sql)->result_array();
	}

	# funder model upsert
	# check if funder exists by name, than skip inserting funder goto insert submission funder
	# check if funder not exists by name, than inserting funder and insert submission funder
	public function upsert_funder($data){
		$fund = $this->db->query("select * from funder where funder_name = '".$data['funder_name']."'")->result_array();
		if(count($fund) > 0){
			# insert submission funder
			$datasub = array(
				'sub_id'	=> $data['sub_id'],
				'funder_id'	=> $fund[0]['funder_id'],
				'funder_desc'	=> $data['funder_desc'],
				'award_number' => $data['award_number']
			);
			return $this->db->insert('submission_funder', $datasub);
		}else{
			$datafunder = array(
				'funder_name' => $data['funder_name']				
			);
			$this->db->insert('funder', $datafunder);
			$id = $this->db->insert_id();
			$datasub = array(
				'sub_id' => $data['sub_id'],
				'funder_id' => $id,
				'funder_desc' => $data['funder_desc'],
				'award_number' => $data['award_number']
			);
			return $this->db->insert('submission_funder', $datasub);
		}
	}

	public function get_submission_funder($sub_id){
		$sql = "select a.*, b.funder_name from submission_funder a left join funder b on a.funder_id = b.funder_id where a.sub_id = '$sub_id' order by date_input DESC";
		return $this->db->query($sql)->result_array();
	}

	public function get_manuscript_file($sid){
		$sql = "select * from submission_file where type = 1 and sub_id = '$sid'";
		return $this->db->query($sql)->result_array();
	}

	public function get_manuscript_file_type($sid, $round, $type){		
		$sql = "select * from submission_file where type = '$type' and sub_id = '$sid' and round = '$round'";
		if ($round == 9)
			$sql = "select * from submission_file where type = '$type' and sub_id = '$sid' order by sf_id DESC";
		return $this->db->query($sql)->result_array();
	}

	public function clear_submission_funder($sub_id){
		$sql = "delete from submission_funder where sub_id = '$sub_id'";
		return $this->db->query($sql);
	}

	public function clear_submission($sub_id){
		$this->db->query("delete from submission_log_status where sub_id = '$sub_id'");
		$this->db->query("delete from submission_funder where sub_id = '$sub_id'");
		$this->db->query("delete from submission_author where sub_id = '$sub_id'");
		$this->db->query("delete from submission_file where sub_id = '$sub_id'");
		$this->db->query("delete from submission_reviewer where sub_id = '$sub_id'");
		$this->db->query("delete from submission_review where sub_id = '$sub_id'");
		$this->db->query("delete from journal where sub_id = '$sub_id'");
		return true;
	}

	# reviewer 
	public function get_journal_review_user($email, $status = ''){
		$sql = "select a.*, c.*, b.section_title, b.section_abv from submission a left join section b on a.section_id = b.section_id 
				right join submission_review c on a.sub_id = c.sub_id 
				where c.reviewer_email = '$email' and date_review IS NULL and a.sub_status not in (99) order by a.date_submit DESC";
		if($status !== ''){
			$sql = "select a.*, c.*, b.section_title, b.section_abv from submission a left join section b on a.section_id = b.section_id 
					right join submission_review c on a.sub_id = c.sub_id where c.reviewer_email = '$email' and date_review IS NOT NULL and a.sub_status not in (99) order by a.date_submit DESC";
			if($status == 'active'){
				$sql = "select a.*, c.*, b.section_title, b.section_abv from submission a left join section b on a.section_id = b.section_id 
					right join submission_review c on a.sub_id = c.sub_id where c.reviewer_email = '$email' and date_review IS NULL and a.sub_status not in (99) order by a.date_submit DESC";
			}
		}
		
		return $this->db->query($sql)->result_array();
	}

	public function check_count_reviewer_approve($sub_id){
		$sql = "select * from submission_reviewer where sub_id = '$sub_id' and status = 1";
		return $this->db->query($sql)->num_rows();
	}

	public function check_count_reviewer_assign($sub_id){
		$sql = "select * from submission_reviewer where sub_id = '$sub_id' and status = 2";
		return $this->db->query($sql)->num_rows();
	}

	public function current_review($review_id){
		$sql = "select * from submission_review where review_id = '$review_id'";
		return $this->db->query($sql)->result_array();
	}

	public function get_review_submission($sub_id, $round = null){
		$sql = "select * from submission_review where sub_id = '$sub_id' and review_result is NOT NULL";
		if($round !== null)
			$sql = "select * from submission_review where (sub_id = '$sub_id' and round = '$round') and review_result is NOT NULL";
		return $this->db->query($sql)->result_array();
	}

	public function get_log_submission_status($sub_id){
		$sql = "select * from submission_log_status where sub_id = '$sub_id' order by date_log ASC";
		return $this->db->query($sql)->result_array();
	}

	# submission screening
	public function get_all_screening_result($sub_id){
		$sql = "select * from submission_screening where sub_id = '$sub_id' and type = 0 order by screening_id ASC";
		return $this->db->query($sql)->result_array();
	}

	public function is_pass_screening_by_eic($sub_id){
		$sql = "select * from submission_screening where sub_id = '$sub_id' and type = 0 order by screening_id DESC limit 0,1";
		$data = $this->db->query($sql)->result_array();
		$res = false;
		if(!empty($data)){
			if($data[0]['eic'] == 1)
				$res = true;
		}
		return $res;
	}
	
	public function get_current_screening($id){
		$sql = "select * from submission_screening where screening_id = '$id'";
		return $this->db->query($sql)->result_array();
	}

	public function get_message_screening($id){
		$sql = "select * from submission_screening where screening_id = '$id'";
		$data = $this->db->query($sql)->result_array();
		$sub_id = $data[0]['sub_id'];
		$round = $data[0]['round'];		
		
		$res = array(
			'sender' => $this->get_user($data[0]['user_id']),
			'submission' => $this->current_submission($sub_id),
			'screening' => $data,
			'author'	=> $this->get_author_submission($sub_id),
			'review_result' => $this->get_review_submission($sub_id, $round),
		);
		return $res;
	}

	public function get_submission_screening($sub_id, $round = ''){
		$sql = "select * from submission_screening where sub_id = '$sub_id'";
		if($round !== '')
			$sql = "select * from submission_screening where sub_id = '$sub_id' and round = '$round'";
		return $this->db->query($sql)->result_array();
	}
	
	public function get_last_screening($sub_id){
		$sql = "select * from submission_screening where sub_id = '$sub_id' and type = 0 order by screening_id DESC limit 0,1";
		return $this->db->query($sql)->result_array();
	}

	# checking view conditions
	# ==============================================
	public function check_enable_screening($sub_id){
		$sql = "select * from submission_screening where sub_id = '$sub_id' order by date_input DESC limit 0, 1";
		$data = $this->db->query($sql)->result_array();		
		$res = true;
		if(!empty($data)){
			if($data[0]['type'] == 1)
				$res = false;
			// else{
			// 	// if($data[0]['author_respond'] == 0)
			// 	$res = false;
			// }
		}
		return $res;
	}

	public function check_enable_confirm_revise($sub_id){
		$sql = "select * from submission_screening where sub_id = '$sub_id' order by date_input DESC limit 0, 1";
		$data = $this->db->query($sql)->result_array();		
		$res = false;
		if(!empty($data)){
			if($data[0]['author_respond'] == 0 && $data[0]['status'] == 2)
				$res = true;
		}
		return $res;
	}

	public function revise_agreement($sub_id){
		$last = $this->db->query("select * from submission_screening where sub_id = '$sub_id' order by screening_id DESC limit 0, 1")->result_array();
		$id = $last[0]['screening_id'];		
		$this->db->query("update submission_screening set author_respond = '1' where screening_id = '$id'");
		if ($last[0]['type'] == 1){			
			$act = "update submission set round = ".($last[0]['round']+1)." where sub_id = '$sub_id'";
			return $this->db->query($act);
		}else
			return false;
	}

	public function check_screening($sub_id){
		$sql = "select * from submission_screening where sub_id = '$sub_id' and type = 1";
		return $this->db->query($sql)->num_rows();		
	}

	public function check_show_suggest_reviewer($sub_id){
		$sql = "select * from submission_screening where sub_id = '$sub_id' and status not in (2,3)";
		return $this->db->query($sql)->num_rows();
	}

	# journal model
	public function get_current_journal($sub_id){
		$sql = "select * from journal a 
				left join issue i on a.issue_id = i.issue_id 
				left join submission b on a.sub_id = b.sub_id 
				left outer join section c on b.section_id = c.section_id
				where a.sub_id = '$sub_id'";
		return $this->db->query($sql)->result_array();
	}
	public function check_journal_exists($sub_id){
		$sql = "select * from journal where sub_id = '$sub_id'";
		return $this->db->query($sql)->num_rows();
	}

	public function get_date_log($sub_id, $status){
		$sql = "select date_log from submission_log_status where sub_id = '$sub_id' and sub_status = '$status' order by date_log ASC";
		$data = $this->db->query($sql)->result_array();
		if(!empty($data))
			return $data[0]['date_log'];
		return '';
	}

	public function people(){
		$sql = "select * from people order by status ASC";
		return $this->db->query($sql)->result_array();
	}

	public function current_people($pid){
		$sql = "select * from people where pid = '$pid'";
		return $this->db->query($sql)->result_array();
	}

	/* migrate model */
	public function migrate_journal($data){
		$sub = array(
			'section_id' => $data['section_id'],
			'sub_title' => $data['title'],
			'abstract'	=> $data['abstract'],
			'keywords'	=> $data['keywords'],
			'sub_status'	=> 11,
			'date_input'	=> date('Y-m-d H:i:s'),
			'date_update'	=> date('Y-m-d H:i:s'),
			'date_submit'	=> date('Y-m-d H:i:s'),
			'user_id'	=> $this->session->userdata('user_id')
		);		
		$this->db->insert('submission', $sub);
		$sub_id = $this->db->insert_id();
		$_data = array(
			'sub_id' => $sub_id,
			'issue_id' => $data['issue_id'],
			'title'	=> $data['title'],
			'keywords'	=> $data['keywords'],
			'abstract'	=> $data['abstract'],
			'date_accept'	=> $sub['date_submit'],
			'date_submit'	=> $sub['date_submit']
		);
		$act = $this->db->insert('journal', $_data);
		if($act)
			return $sub_id;
	}

	# model update @ 29 April 2017
	# =======================================================================
	public function get_user_privilage($uid){
		$sql = "select role_id from roleuser where user_id = '$uid'";
		$role = array();
		$data = $this->db->query($sql)->result_array();
		if(!empty($data)){
			foreach($data as $p){
				array_push($role, $p['role_id']);
			}
		}
		return $role;
	}

	public function change_privilage($uid, $priv){
		$_clear = $this->db->query("delete from roleuser where user_id = '$uid'");
		if($priv == 5){
			$this->db->insert('roleuser', array('user_id' => $uid, 'role_id' => 5, 'date_create' => date('Y-m-d H:i:s')));
			$this->db->insert('roleuser', array('user_id' => $uid, 'role_id' => 6, 'date_create' => date('Y-m-d H:i:s')));
		}else
			$this->db->insert('roleuser', array('user_id' => $uid, 'role_id' => $priv, 'date_create' => date('Y-m-d H:i:s')));

		return true;
	}

}